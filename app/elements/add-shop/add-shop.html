<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/marked-element/marked-element.html">



<dom-module id="add-shop">
  <template>
    <style include="shared-styles">
      .cafe-header { @apply(--paper-font-headline); }
      .cafe-light { color: var(--paper-grey-600); }
      .cafe-location {
        float: right;
        font-size: 15px;
        vertical-align: middle;
    }

    #text-input{
      border-radius: 0px;
      /*height: 100%;*/
      padding: 0px 0 0px 0;
      width: 100%;
      margin: 0px auto;
      background: white;
      margin: 0;
      height: 50vh;
    }

    iron-icon.star:last-of-type { color: var(--paper-grey-500); }
      paper-card {
        text-decoration: none;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;
        border-radius: 2px;
        height: 100%;
        padding: 16px 0 16px 0;
        width: calc(98.66% - 16px);
        margin: 16px 16px;
        background: white;
      }

      span,
      input {
        @apply(--paper-font-body2);
        display: none;
      }

      #toast {
        --paper-toast-background-color: white;

      }
      paper-progress {
        --paper-progress-transition-duration: 0.08s;
        --paper-progress-transition-timing-function: ease;
        --paper-progress-transition-transition-delay: 0s;
        --paper-progress-height: 8px;
        border-radius: 2px;
        height: 100%;
        padding: 16px 0 16px 0;
        width: calc(98.66% - 16px);
        margin: 16px 16px;
        background: white;
      }

    </style>


  <paper-card>

    <div class="card-actions">
      <p>Upload an Image</p>
      <div class="horizontal justified">
        <label for="file-input">
            <paper-icon-button type="file" icon="image:photo-camera"> </iron-icon></paper-icon-button>
        </label>
      <paper-toast id="toast" class="fit-bottom">  <paper-progress id="uploader"></paper-progress></paper-toast>

      <input id="file-input" type="file" />
      </div>
    </div>

    <div class="card-content">

      <p class="cafe-light">
        <marked-element markdown="{{entry}}">
            <div class="markdown-html"></div>
        </marked-element>

      </p>

      <div class="cafe-rating">
        <iron-autogrow-textarea id="text-input" rows="4" style="max-height: 200px;" value="{{entry::input}}"></iron-autogrow-textarea>
      </div>

    </div>
  </paper-card>


  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'add-shop',

        listeners: {
        'file-input.change': 'imageUploadTap'
        },

        properties: {
          items: {
            type: Array,
            notify: true
          },
          entry: {
            type: String,
            value: '## write something!',
            notify: true
          }
        },
        imageUploadTap: function(e) {

          var file = e.target.files[0];
          console.log(file);
          var storageRef = firebase.storage().ref('images/' + file.name);
          var uploadTask = storageRef.put(file);
          uploadTask.on('state_changed', function progress(snapshot){
            var precentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100
            console.log(precentage);
            this.$.uploader = precentage;
          },
          function error(err){

          },
          function (){

            var newPostKey = firebase.database().ref().child('Posts').push().key;
            var user = firebase.auth().currentUser;
            var downloadURL = uploadTask.snapshot.downloadURL;
            var updates = {};
            var postData = {
              url: downloadURL,
              user: user.uid
            };
            updates['/Posts/' + newPostKey] = postData;
            firebase.database().ref().update(updates);
          })

          this.$.toast.open();
       },

      });
    })();
  </script>
</dom-module>
